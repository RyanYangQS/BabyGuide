# 儿童健康管理小程序 - 技术方案

## 一、技术栈选型

### 1.1 前端技术栈

#### 框架选择
- **框架**: Next.js 14 (React框架)
- **语言**: TypeScript
- **样式**: Tailwind CSS
- **组件库**: shadcn/ui
- **状态管理**: Zustand
- **图表库**: Recharts

#### 为什么选择Next.js?
- ✅ 支持SSR/SSG,SEO友好
- ✅ 天然支持Vercel部署
- ✅ 内置API Routes,无需单独后端
- ✅ 优秀的开发体验
- ✅ 文件系统路由,开发效率高

### 1.2 后端技术栈

#### 数据库选择
- **主数据库**: Supabase (PostgreSQL)
- **文件存储**: Supabase Storage
- **实时订阅**: Supabase Realtime

#### 为什么选择Supabase?
- ✅ 免费额度充足(500MB数据库,1GB文件存储)
- ✅ 提供完整的后端服务(Auth、Database、Storage)
- ✅ PostgreSQL数据库,功能强大
- ✅ 内置实时订阅功能
- ✅ 优秀的Dashboard和管理工具
- ✅ 支持Row Level Security(RLS)

#### 备选方案
- **MongoDB Atlas**: 512MB免费额度,文档数据库
- **PlanetScale**: 5GB免费额度,MySQL兼容
- **Firebase**: 1GB免费额度,NoSQL数据库

### 1.3 部署方案

#### 前端部署
- **平台**: Vercel
- **域名**: baby.yangqingsong.top
- **CDN**: Vercel Edge Network

#### 为什么选择Vercel?
- ✅ 免费额度充足
- ✅ 自动CI/CD
- ✅ 全球CDN加速
- ✅ 预览部署
- ✅ 零配置部署Next.js

---

## 二、域名配置方案

### 2.1 子域名规划

您的主域名是 `yangqingsong.top`,可以配置多个子域名:

```
主域名: yangqingsong.top
├── blog.yangqingsong.top      (博客 - 已使用)
├── baby.yangqingsong.top      (儿童健康管理小程序 - 新增)
├── api.yangqingsong.top       (API服务 - 可选)
└── admin.yangqingsong.top     (管理后台 - 可选)
```

### 2.2 DNS配置

在域名服务商(如阿里云、腾讯云)配置:

```bash
# 博客 (已配置)
CNAME blog -> your-blog-platform.com

# 儿童健康管理小程序
CNAME baby -> cname.vercel-dns.com

# API服务 (可选)
CNAME api -> cname.vercel-dns.com

# 管理后台 (可选)
CNAME admin -> cname.vercel-dns.com
```

### 2.3 Vercel域名配置

1. 在Vercel项目设置中添加域名
2. 选择 `baby.yangqingsong.top`
3. Vercel会自动配置SSL证书
4. 等待DNS生效(通常几分钟到几小时)

---

## 三、数据库设计

### 3.1 数据表结构

#### 儿童档案表 (children)
```sql
CREATE TABLE children (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES auth.users NOT NULL,
  name VARCHAR(50) NOT NULL,
  gender VARCHAR(10) NOT NULL,
  birthday DATE NOT NULL,
  blood_type VARCHAR(10),
  allergies TEXT,
  avatar_url TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 索引
CREATE INDEX idx_children_user_id ON children(user_id);
CREATE INDEX idx_children_created_at ON children(created_at DESC);
```

#### 体温记录表 (temperature_records)
```sql
CREATE TABLE temperature_records (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  child_id UUID REFERENCES children(id) ON DELETE CASCADE,
  temperature DECIMAL(4,1) NOT NULL,
  measure_time TIMESTAMP WITH TIME ZONE NOT NULL,
  measure_part VARCHAR(20) NOT NULL, -- 腋下/口腔/耳温/肛温
  notes TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 索引
CREATE INDEX idx_temperature_child_id ON temperature_records(child_id);
CREATE INDEX idx_temperature_measure_time ON temperature_records(measure_time DESC);
```

#### 用药记录表 (medicine_records)
```sql
CREATE TABLE medicine_records (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  child_id UUID REFERENCES children(id) ON DELETE CASCADE,
  medicine_name VARCHAR(100) NOT NULL,
  dosage VARCHAR(50) NOT NULL,
  take_time TIMESTAMP WITH TIME ZONE NOT NULL,
  next_available_time TIMESTAMP WITH TIME ZONE,
  notes TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 索引
CREATE INDEX idx_medicine_child_id ON medicine_records(child_id);
CREATE INDEX idx_medicine_take_time ON medicine_records(take_time DESC);
```

#### 症状记录表 (symptom_records)
```sql
CREATE TABLE symptom_records (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  child_id UUID REFERENCES children(id) ON DELETE CASCADE,
  symptoms TEXT[] NOT NULL, -- 症状类型数组
  description TEXT,
  images TEXT[], -- 图片URL数组
  record_time TIMESTAMP WITH TIME ZONE NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 索引
CREATE INDEX idx_symptom_child_id ON symptom_records(child_id);
CREATE INDEX idx_symptom_record_time ON symptom_records(record_time DESC);
```

#### 家庭成员表 (family_members)
```sql
CREATE TABLE family_members (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  family_id UUID NOT NULL,
  user_id UUID REFERENCES auth.users NOT NULL,
  role VARCHAR(20) NOT NULL, -- 爸爸/妈妈/爷爷/奶奶/外公/外婆
  permission VARCHAR(20) NOT NULL, -- admin/view
  invited_by UUID REFERENCES auth.users,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 索引
CREATE INDEX idx_family_members_family_id ON family_members(family_id);
CREATE INDEX idx_family_members_user_id ON family_members(user_id);
```

#### 药品信息表 (medicines)
```sql
CREATE TABLE medicines (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name VARCHAR(100) NOT NULL,
  generic_name VARCHAR(100), -- 通用名
  min_interval_hours INTEGER NOT NULL, -- 最小间隔小时
  max_daily_count INTEGER NOT NULL, -- 每日最大次数
  min_age_months INTEGER, -- 最小适用年龄(月)
  max_age_months INTEGER, -- 最大适用年龄(月)
  description TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 初始数据
INSERT INTO medicines (name, generic_name, min_interval_hours, max_daily_count, min_age_months) VALUES
('美林', '布洛芬', 4, 4, 6),
('泰诺林', '对乙酰氨基酚', 4, 4, 3);
```

### 3.2 Row Level Security (RLS)

Supabase的RLS确保数据安全:

```sql
-- 启用RLS
ALTER TABLE children ENABLE ROW LEVEL SECURITY;
ALTER TABLE temperature_records ENABLE ROW LEVEL SECURITY;
ALTER TABLE medicine_records ENABLE ROW LEVEL SECURITY;
ALTER TABLE symptom_records ENABLE ROW LEVEL SECURITY;

-- 儿童档案: 用户只能查看自己的儿童
CREATE POLICY "Users can view their own children"
  ON children FOR SELECT
  USING (auth.uid() = user_id);

CREATE POLICY "Users can insert their own children"
  ON children FOR INSERT
  WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update their own children"
  ON children FOR UPDATE
  USING (auth.uid() = user_id);

CREATE POLICY "Users can delete their own children"
  ON children FOR DELETE
  USING (auth.uid() = user_id);

-- 类似地为其他表创建RLS策略
```

---

## 四、项目结构

```
baby-guide/
├── src/
│   ├── app/                    # Next.js App Router
│   │   ├── (auth)/            # 认证相关页面
│   │   │   ├── login/
│   │   │   └── register/
│   │   ├── (dashboard)/       # 主应用页面
│   │   │   ├── page.tsx       # 首页
│   │   │   ├── temperature/   # 体温记录
│   │   │   ├── medicine/      # 用药管理
│   │   │   └── profile/       # 我的
│   │   ├── api/               # API Routes
│   │   │   ├── children/
│   │   │   ├── temperature/
│   │   │   ├── medicine/
│   │   │   └── symptoms/
│   │   ├── layout.tsx
│   │   └── globals.css
│   ├── components/            # 组件
│   │   ├── ui/               # shadcn/ui组件
│   │   ├── temperature/      # 体温相关组件
│   │   ├── medicine/         # 用药相关组件
│   │   └── common/           # 通用组件
│   ├── lib/                  # 工具库
│   │   ├── supabase/         # Supabase客户端
│   │   ├── utils/            # 工具函数
│   │   └── constants/        # 常量
│   ├── hooks/                # 自定义Hooks
│   ├── store/                # Zustand状态管理
│   └── types/                # TypeScript类型定义
├── public/                   # 静态资源
├── .env.local               # 环境变量
├── next.config.js           # Next.js配置
├── tailwind.config.js       # Tailwind配置
├── tsconfig.json            # TypeScript配置
└── package.json
```

---

## 五、核心功能实现

### 5.1 用户认证

```typescript
// src/lib/supabase/auth.ts
import { createClient } from '@supabase/supabase-js'

const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
)

// 微信登录
export async function signInWithWechat() {
  const { data, error } = await supabase.auth.signInWithOAuth({
    provider: 'wechat',
    options: {
      redirectTo: `${window.location.origin}/auth/callback`
    }
  })
  return { data, error }
}

// 手机号登录
export async function signInWithPhone(phone: string) {
  const { data, error } = await supabase.auth.signInWithOtp({
    phone,
    options: {
      channel: 'sms'
    }
  })
  return { data, error }
}
```

### 5.2 体温记录

```typescript
// src/lib/api/temperature.ts
import { supabase } from '@/lib/supabase'

// 添加体温记录
export async function addTemperatureRecord(data: {
  childId: string
  temperature: number
  measureTime: Date
  measurePart: string
  notes?: string
}) {
  const { data: record, error } = await supabase
    .from('temperature_records')
    .insert({
      child_id: data.childId,
      temperature: data.temperature,
      measure_time: data.measureTime,
      measure_part: data.measurePart,
      notes: data.notes
    })
    .select()
    .single()

  return { record, error }
}

// 获取体温记录
export async function getTemperatureRecords(
  childId: string,
  startDate?: Date,
  endDate?: Date
) {
  let query = supabase
    .from('temperature_records')
    .select('*')
    .eq('child_id', childId)
    .order('measure_time', { ascending: false })

  if (startDate) {
    query = query.gte('measure_time', startDate.toISOString())
  }
  if (endDate) {
    query = query.lte('measure_time', endDate.toISOString())
  }

  const { data, error } = await query
  return { data, error }
}
```

### 5.3 智能用药管理

```typescript
// src/lib/api/medicine.ts
import { supabase } from '@/lib/supabase'

// 检查用药间隔
export async function checkMedicineInterval(
  childId: string,
  medicineName: string
) {
  // 获取药品信息
  const { data: medicine } = await supabase
    .from('medicines')
    .select('*')
    .eq('name', medicineName)
    .single()

  if (!medicine) return { canTake: false, reason: '药品信息不存在' }

  // 获取最近24小时的用药记录
  const twentyFourHoursAgo = new Date(Date.now() - 24 * 60 * 60 * 1000)
  const { data: recentRecords } = await supabase
    .from('medicine_records')
    .select('*')
    .eq('child_id', childId)
    .eq('medicine_name', medicineName)
    .gte('take_time', twentyFourHoursAgo.toISOString())
    .order('take_time', { ascending: false })

  // 检查24小时用药次数
  if (recentRecords && recentRecords.length >= medicine.max_daily_count) {
    return {
      canTake: false,
      reason: `24小时内已用药${recentRecords.length}次,已达上限`
    }
  }

  // 检查用药间隔
  if (recentRecords && recentRecords.length > 0) {
    const lastRecord = recentRecords[0]
    const lastTakeTime = new Date(lastRecord.take_time)
    const nextAvailableTime = new Date(
      lastTakeTime.getTime() + medicine.min_interval_hours * 60 * 60 * 1000
    )

    if (new Date() < nextAvailableTime) {
      return {
        canTake: false,
        reason: `距离下次用药还需等待`,
        nextAvailableTime
      }
    }
  }

  return { canTake: true }
}

// 添加用药记录
export async function addMedicineRecord(data: {
  childId: string
  medicineName: string
  dosage: string
  takeTime: Date
  notes?: string
}) {
  // 先检查用药间隔
  const checkResult = await checkMedicineInterval(
    data.childId,
    data.medicineName
  )

  if (!checkResult.canTake) {
    return { error: checkResult.reason }
  }

  // 计算下次可用时间
  const { data: medicine } = await supabase
    .from('medicines')
    .select('min_interval_hours')
    .eq('name', data.medicineName)
    .single()

  const nextAvailableTime = new Date(
    data.takeTime.getTime() + medicine.min_interval_hours * 60 * 60 * 1000
  )

  // 插入记录
  const { data: record, error } = await supabase
    .from('medicine_records')
    .insert({
      child_id: data.childId,
      medicine_name: data.medicineName,
      dosage: data.dosage,
      take_time: data.takeTime,
      next_available_time: nextAvailableTime,
      notes: data.notes
    })
    .select()
    .single()

  return { record, error }
}
```

### 5.4 实时订阅

```typescript
// src/lib/realtime.ts
import { supabase } from '@/lib/supabase'

// 订阅体温记录变化
export function subscribeToTemperature(
  childId: string,
  callback: (payload: any) => void
) {
  return supabase
    .channel('temperature_changes')
    .on(
      'postgres_changes',
      {
        event: '*',
        schema: 'public',
        table: 'temperature_records',
        filter: `child_id=eq.${childId}`
      },
      callback
    )
    .subscribe()
}

// 订阅用药记录变化
export function subscribeToMedicine(
  childId: string,
  callback: (payload: any) => void
) {
  return supabase
    .channel('medicine_changes')
    .on(
      'postgres_changes',
      {
        event: '*',
        schema: 'public',
        table: 'medicine_records',
        filter: `child_id=eq.${childId}`
      },
      callback
    )
    .subscribe()
}
```

---

## 六、部署流程

### 6.1 Supabase配置

1. **创建Supabase项目**
   - 访问 https://supabase.com
   - 创建新项目
   - 记录项目URL和API Key

2. **配置数据库**
   ```bash
   # 在Supabase Dashboard的SQL Editor中执行
   # 创建表结构(见上文数据库设计)
   # 配置RLS策略
   ```

3. **配置认证**
   - 启用微信登录(需要企业认证)
   - 启用手机号登录
   - 配置回调URL

4. **配置存储**
   - 创建 `avatars` bucket (头像)
   - 创建 `symptoms` bucket (症状图片)
   - 配置存储策略

### 6.2 Vercel部署

1. **准备代码仓库**
   ```bash
   # 初始化Git仓库
   git init
   git add .
   git commit -m "Initial commit"

   # 推送到GitHub
   git remote add origin https://github.com/yourusername/baby-guide.git
   git push -u origin main
   ```

2. **连接Vercel**
   - 访问 https://vercel.com
   - 导入GitHub仓库
   - 选择Next.js框架
   - 配置环境变量

3. **配置环境变量**
   ```env
   NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
   NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
   SUPABASE_SERVICE_ROLE_KEY=your_supabase_service_role_key
   ```

4. **配置域名**
   - 在Vercel项目设置中添加域名
   - 添加 `baby.yangqingsong.top`
   - 配置DNS记录

### 6.3 DNS配置

在域名服务商配置:

```bash
# 添加CNAME记录
类型: CNAME
主机记录: baby
记录值: cname.vercel-dns.com
TTL: 600
```

---

## 七、成本估算

### 7.1 免费额度

| 服务 | 免费额度 | 说明 |
|------|---------|------|
| Vercel | 100GB带宽/月 | 足够小型应用使用 |
| Supabase | 500MB数据库 + 1GB存储 | 初期足够使用 |
| 域名 | 已购买 | yangqingsong.top |

### 7.2 预估成本

**初期(0-1000用户)**
- 数据库: 免费(500MB内)
- 存储: 免费(1GB内)
- 带宽: 免费(100GB内)
- **总成本: 0元/月**

**中期(1000-5000用户)**
- 数据库: 约$25/月(如需扩容)
- 存储: 约$5/月(如需扩容)
- 带宽: 免费
- **总成本: 约$30/月(约200元)**

---

## 八、开发计划

### 8.1 开发阶段

#### 第一阶段: 基础功能(2-3周)
- ✅ 项目初始化
- ✅ 数据库设计和配置
- ✅ 用户认证
- ✅ 儿童档案管理
- ✅ 体温记录功能
- ✅ 用药记录功能

#### 第二阶段: 核心功能(2-3周)
- ✅ 智能用药提醒
- ✅ 体温曲线图表
- ✅ 症状记录功能
- ✅ 家庭成员协同
- ✅ 实时数据同步

#### 第三阶段: 优化完善(1-2周)
- ✅ 性能优化
- ✅ UI/UX优化
- ✅ 错误处理
- ✅ 测试和调试
- ✅ 部署上线

### 8.2 技术难点

1. **微信登录认证**
   - 需要企业认证
   - 备选方案: 手机号登录

2. **实时数据同步**
   - 使用Supabase Realtime
   - 处理网络断连

3. **用药间隔计算**
   - 跨天计算
   - 时区处理

4. **数据安全**
   - RLS策略配置
   - 敏感数据加密

---

## 九、后续扩展

### 9.1 功能扩展

1. **微信小程序版本**
   - 使用Taro或uni-app
   - 共享后端API

2. **AI智能建议**
   - 集成AI模型
   - 提供护理建议

3. **数据导出**
   - PDF报告生成
   - Excel数据导出

4. **疫苗接种提醒**
   - 接种计划管理
   - 自动提醒

### 9.2 性能优化

1. **缓存策略**
   - Redis缓存
   - CDN加速

2. **数据库优化**
   - 索引优化
   - 查询优化

3. **前端优化**
   - 代码分割
   - 图片懒加载

---

## 十、总结

本技术方案采用现代化的技术栈,充分利用免费资源,实现了一个功能完善、性能优良的儿童健康管理应用。

**核心优势:**
- ✅ 完全免费起步,成本可控
- ✅ 技术栈现代化,易于维护
- ✅ 部署简单,自动化程度高
- ✅ 可扩展性强,支持后续发展

**技术亮点:**
- ✅ Next.js + TypeScript,开发体验优秀
- ✅ Supabase提供完整后端服务
- ✅ Vercel自动化部署和CDN加速
- ✅ 子域名灵活配置,不影响现有博客

**推荐子域名:**
- `baby.yangqingsong.top` - 儿童健康管理小程序
- 简洁易记,语义明确
